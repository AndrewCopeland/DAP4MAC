---
- name: Check if Jenkins is already running and set status
  block:
    - name: Check if jenkins is running
      uri:
        url: "http://{{jenkinsIngressRoute}}"
        return_content: yes
        body_format: json
        validate_certs: no
        method: GET
        status_code: 200, 404
      register: jenkinsWeb
      until: jenkinsWeb.status == 200
      retries: 60
      delay: 2
      
    - name: Set jenkins status to up
      set_fact:
        jenkinsStatus: "up"
      when: jenkinsWeb.status == 200

    - name: Set jenkins status to down
      set_fact:
        jenkinsStatus: "down"
      when: jenkinsWeb.status == 404

- name: Check if Jenkins plugins are loaded
  block:
  - name: Check if jenkins pluins are configured
    uri:
      url: "http://{{ jenkinsIngressRoute }}/pluginManager/installed"
      status_code: 200
      return_content: yes
      validate_certs: NO
      method: GET
      follow_redirects: all
    register: jenkinsPluginStatus
    when: jenkinsStatus == "up"
  
  - name: Set jenkins status to 'plugins configured'.
    set_fact:
      jenkinsStatus: "pluginsConfigured"
    when: '"Allows credentials to be bound to environment variables for use from miscellaneous build steps." in jenkinsPluginStatus.content'

  - name: Set jenkins status to plugins not configured'.
    set_fact:
      jenkinsStatus: "pluginsNotConfigured"
    when: '"Allows credentials to be bound to environment variables for use from miscellaneous build steps." not in jenkinsPluginStatus.content'

  when: jenkinsStatus == "up"
 
- name: Configure Jenkins
  block:
    - name: Load Jenkins plugins
      uri:
        url: "http://{{ jenkinsIngressRoute }}/pluginManager/installNecessaryPlugins"
        body_format: raw
        status_code: 200
        return_content: yes
        validate_certs: NO
        body: <jenkins><install plugin="{{ plugin }}@latest"/></jenkins>
        method: POST
        follow_redirects: all
      register: jenkins_plugins
      until: jenkins_plugins.status == 200
      retries: 60
      delay: 2
      with_items:
      - "{{ jenkinsPlugins }}"
      loop_control:
        loop_var: plugin

  when: jenkinsStatus == "pluginsNotConfigured"